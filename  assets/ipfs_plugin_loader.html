<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/ipfs@0.60.0/dist/index.min.js"></script>
</head>
<body>
  <script>
    let ipfsNode = null;

    async function getIpfs() {
      if (ipfsNode) return ipfsNode;
      ipfsNode = await Ipfs.create({ repo: 'true-ledger-plugins' });
      return ipfsNode;
    }

    // Fetch JSON object from IPFS
    window.ipfsFetchJson = async (cid) => {
      const node = await getIpfs();
      const data = await node.cat(cid);
      return new TextDecoder().decode(data);
    };

    // Fetch raw text (e.g., JS code)
    window.ipfsFetchText = async (cid) => {
      const node = await getIpfs();
      const data = await node.cat(cid);
      return new TextDecoder().decode(data);
    };

    // Evaluate plugin code in isolated context
    window.executePlugin = (jsCode) => {
      try {
        // Use indirect eval to avoid access to window
        (0, eval)(jsCode);
      } catch (e) {
        console.error('Plugin execution error:', e);
        window.flutterPostMessage(JSON.stringify({
          type: 'pluginError',
          error: e.message
        }));
      }
    };

    // Send messages to Flutter
    window.flutterPostMessage = (msg) => {
      if (window.FlutterBridge) {
        window.FlutterBridge.postMessage(msg);
      } else {
        console.log('FlutterBridge not ready:', msg);
      }
    };

    console.log('IPFS Plugin Loader Ready');
  </script>
</body>
</html>