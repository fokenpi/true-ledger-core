<!-- assets/ipfs_worker.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/ipfs@0.60.0/dist/index.min.js"></script>
</head>
<body>
  <script>
    let ipfsNode = null;

    async function getIpfs() {
      if (ipfsNode) return ipfsNode;
      try {
        ipfsNode = await Ipfs.create({
          repo: 'true-ledger-core',
          start: true,
          EXPERIMENTAL: { pubsub: true }
        });
        window.IpfsBridge.postMessage('nodeReady');
        return ipfsNode;
      } catch (err) {
        console.error('IPFS init error:', err);
        window.IpfsBridge.postMessage('error: ' + err.message);
        throw err;
      }
    }

    window.ipfs = {
      async fetchJson(cid) {
        try {
          const node = await getIpfs();
          const data = await node.cat(cid);
          const str = new TextDecoder().decode(data);
          return JSON.stringify(JSON.parse(str)); // Ensure valid JSON
        } catch (err) {
          console.error('fetchJson error:', err);
          return '{}';
        }
      },

      async fetchText(cid) {
        try {
          const node = await getIpfs();
          const data = await node.cat(cid);
          return new TextDecoder().decode(data);
        } catch (err) {
          console.error('fetchText error:', err);
          return '';
        }
      },

      async pubsubPublish(topic, message) {
        try {
          const node = await getIpfs();
          const encoder = new TextEncoder();
          await node.pubsub.publish(topic, encoder.encode(message));
        } catch (err) {
          console.error('pubsubPublish error:', err);
        }
      }
    };

    console.log('IPFS Worker Initialized');
    // Add to window.ipfs object
window.ipfs.pubsubSubscribe = (topic, callback) => {
  getIpfs().then(node => {
    node.pubsub.subscribe(topic, (msg) => {
      const str = new TextDecoder().decode(msg.data);
      // Post to Flutter
      if (window.IpfsBridge) {
        window.IpfsBridge.postMessage(JSON.stringify({
          type: 'pubsub',
          topic: topic,
          message: str
        }));
      }
    });
  }).catch(err => console.error('PubSub subscribe error:', err));
};
  </script>
</body>
</html>